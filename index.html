<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <title>RS Internal Inventory</title>
  <meta name="viewport" content="width=device-width, initial-scale=1" />

  <!--
    Robert Slack Internal Inventory Portal (v1)
    ------------------------------------------------------
    FRONTEND-ONLY IMPLEMENTATION

    EXPECTED COMPANION FILES (same directory or adjust paths in JS):
      - inventory.json   <-- CSV converted to JSON array of objects
           (columns from Inventory.csv):
             EquipmentType
             SerialNumber
             Size
             Model
             Brand
             Condition
             Processor
             RAM
             Storage
             ID
             " Price " (full retail, optional)
             EmployeePricing  <-- employee discount price
             Available        <-- "y" or "n"
      - /images/monitor.png
      - /images/AIO.png
      - /images/Laptop.png
      - Optional per-item images:
          /images/{ID}.jpg
          /images/{ID}.png
          /images/{ID}.img

    This file:
      - Lets users browse inventory by equipment type
      - Shows cards including Brand, Model, Size, full Price and EmployeePricing
      - Allows employees to claim an item
      - Checks latest availability:
          * on initial load,
          * when "Claim this item" is clicked, and
          * when "Submit" is clicked,
        each time re-reading inventory.json and matching by ID
      - Sends all non-blank inventory values + claimer info to your Pipedream URL

    To customize:
      - Adjust EQUIPMENT_TYPES in the JS CONFIG section
      - Adjust paths / field names in the JS helper functions
      - Adjust styling in the CSS section
  -->

  <style>
    :root {
      --bg: #0f172a;
      --bg-elevated: #111827;
      --bg-card: #020617;
      --bg-card-alt: #0b1120;
      --accent: #38bdf8;
      --accent-soft: rgba(56, 189, 248, 0.12);
      --accent-strong: #0ea5e9;
      --danger: #f97373;
      --danger-soft: rgba(239, 68, 68, 0.12);
      --text: #e5e7eb;
      --text-soft: #9ca3af;
      --border-subtle: rgba(148, 163, 184, 0.4);
      --border-strong: rgba(148, 163, 184, 0.7);
      --radius-lg: 16px;
      --radius-md: 12px;
      --radius-sm: 8px;
      --shadow-soft: 0 20px 40px rgba(15, 23, 42, 0.7);
      --shadow-subtle: 0 8px 16px rgba(15, 23, 42, 0.65);
      --transition-fast: 150ms ease-out;
      --transition-med: 220ms ease;
    }

    * {
      box-sizing: border-box;
    }

    body {
      margin: 0;
      padding: 0;
      font-family: system-ui, -apple-system, BlinkMacSystemFont, "SF Pro Text",
        "Segoe UI", sans-serif;
      background: radial-gradient(circle at top left, #1e293b 0, #020617 55%);
      color: var(--text);
      min-height: 100vh;
      display: flex;
      justify-content: center;
      align-items: flex-start;
    }

    .app-shell {
      width: 100%;
      max-width: 1080px;
      padding: 24px 16px 40px;
    }

    @media (min-width: 768px) {
      .app-shell {
        padding: 32px 24px 48px;
      }
    }

    .app-card {
      background: linear-gradient(135deg, #020617 0%, #020617 45%, #020617 100%);
      border-radius: 24px;
      border: 1px solid rgba(148, 163, 184, 0.5);
      box-shadow: var(--shadow-soft);
      padding: 20px 18px 24px;
      backdrop-filter: blur(24px);
    }

    @media (min-width: 768px) {
      .app-card {
        padding: 26px 24px 30px;
      }
    }

    .header-row {
      display: flex;
      flex-direction: column;
      align-items: center;      /* center horizontally */
      text-align: center;       /* center text inside */
      gap: 12px;                /* a little more breathing room */
      margin-bottom: 32px;      /* more space below header */
    }

    /* You can delete the old 640px media rule entirely,
       or leave this noop version if you like: */
    @media (min-width: 640px) {
      .header-row {
        flex-direction: column; /* keep it stacked & centered on larger screens */
      }
    }

    .title-block {
      display: flex;
      flex-direction: column;
      align-items: center;   /* center content */
      gap: 8px;              /* a bit more spacing between title/subtitles */
      max-width: 44rem;      /* wider for multi-line subtitles */
      margin: 0 auto;
    }

    .app-title {
      font-size: 2.6rem;        /* big, but sane on mobile */
      letter-spacing: 0.02em;
      font-weight: 650;
      display: inline-flex;
      align-items: center;
      justify-content: center;  /* center text + badge together */
      gap: 10px;
    }


    @media (min-width: 768px) {
      .app-title {
        font-size: 3.2rem;      /* larger on desktop */
      }
    }
    
    .app-title-badge {
      font-size: 0.8rem;        /* was 0.7rem */
      padding: 3px 9px;         /* slightly larger pill */
      border-radius: 999px;
      border: 1px solid rgba(56, 189, 248, 0.4);
      color: var(--accent-strong);
      background: linear-gradient(
        120deg,
        rgba(8, 47, 73, 0.9),
        rgba(15, 23, 42, 0.9)
      );
      text-transform: uppercase;
      letter-spacing: 0.08em;
    }


    .lead-subtitle {
      font-size: 1.25rem;   /* was 1.15rem */
      font-weight: 500;
      color: var(--text);   /* a bit brighter to stand out */
    }

    
    .app-subtitle {
      font-size: 1.12rem;   /* was 1.05rem */
      color: var(--text-soft);
      max-width: 40rem;     /* a bit wider paragraph width */
      line-height: 1.7;     /* more comfortable to read */
      margin: 0.2rem auto;  /* center + add vertical rhythm */
      text-align: center;   /* center all subtitle lines */
    }

    .pill-notice {
      align-self: center;                 /* center under subtitles */
      margin-top: 2rem;                   /* more separation from copy */
      font-size: 1rem;                    /* was 0.98rem */
      color: var(--text-soft);
      border-radius: 999px;
      border: 1px dashed rgba(148, 163, 184, 0.7);
      padding: 0.7rem 1.4rem;             /* slightly larger pill */
      display: inline-flex;
      align-items: center;
      gap: 8px;
      background: rgba(15, 23, 42, 0.85);
    }

    .dot {
      width: 7px;
      height: 7px;
      border-radius: 999px;
      background: #22c55e;
      box-shadow: 0 0 0 5px rgba(34, 197, 94, 0.25);
    }

    /* Equipment type selector */
    .type-selector {
      display: flex;
      flex-wrap: wrap;
      gap: 10px;
      margin-bottom: 18px;
    }

    .type-chip {
      position: relative;
      border-radius: 999px;
      border: 1px solid var(--border-subtle);
      padding: 10px 18px;              /* bigger hit area */
      font-size: 0.9rem;               /* larger label text */
      color: var(--text-soft);
      background: rgba(15, 23, 42, 0.9);
      cursor: pointer;
      display: inline-flex;
      align-items: center;
      gap: 8px;                        /* a bit more spacing */
      min-height: 38px;                /* ensures tall enough button */
      transition: border-color var(--transition-fast),
        color var(--transition-fast), background var(--transition-fast),
        transform var(--transition-fast), box-shadow var(--transition-fast);
    }
    
    .type-chip span.icon {
      font-size: 1.05rem;              /* slightly bigger icon */
    }

    .type-chip:hover {
      border-color: rgba(148, 163, 184, 1);
      color: var(--text);
      box-shadow: var(--shadow-subtle);
      transform: translateY(-1px);
    }

    .type-chip.active {
      color: var(--accent-strong);
      border-color: var(--accent-strong);
      background: radial-gradient(
        circle at top left,
        rgba(56, 189, 248, 0.18),
        rgba(15, 23, 42, 0.95)
      );
    }

    .type-chip-badge {
      font-size: 0.7rem;
      padding: 2px 7px;
      border-radius: 999px;
      border: 1px solid rgba(148, 163, 184, 0.6);
      background: rgba(15, 23, 42, 0.9);
      color: var(--text-soft);
    }

    .filters-section {
      margin-bottom: 16px;
      padding: 10px 12px;
      border-radius: var(--radius-md);
      border: 1px solid var(--border-subtle);
      background: rgba(15, 23, 42, 0.9);
      display: flex;
      flex-direction: column;
      gap: 10px;
    }
    
    .filters-header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      gap: 8px;
    }
    
    .filters-title {
      font-size: 0.8rem;
      color: var(--text-soft);
      text-transform: uppercase;
      letter-spacing: 0.08em;
    }
    
    .filters-grid {
      display: flex;
      flex-wrap: wrap;
      gap: 10px 14px;
    }
    
    .filter-group {
      min-width: 0;
      flex: 1 1 180px;
      border-radius: var(--radius-sm);
      border: 1px solid var(--border-subtle);
      background: rgba(15, 23, 42, 0.9);
      padding: 4px 6px 6px;
    }
    
    .filter-label {
      font-size: 0.76rem;
      color: var(--text-soft);
      margin-bottom: 4px;
    }
    
    .filter-chips {
      display: flex;
      flex-wrap: wrap;
      gap: 6px;
    }
    
    /* Filter chips visually consistent with type chips, a bit smaller */
    .filter-chip {
      border-radius: 999px;
      border: 1px solid var(--border-subtle);
      padding: 5px 10px;
      font-size: 0.78rem;
      background: rgba(15, 23, 42, 0.9);
      color: var(--text-soft);
      cursor: pointer;
      display: inline-flex;
      align-items: center;
      gap: 4px;
      transition: border-color var(--transition-fast),
        color var(--transition-fast), background var(--transition-fast),
        transform var(--transition-fast), box-shadow var(--transition-fast);
    }
    
    .filter-chip:hover {
      border-color: rgba(148, 163, 184, 1);
      color: var(--text);
      box-shadow: var(--shadow-subtle);
      transform: translateY(-1px);
    }
    
    .filter-chip.active {
      color: var(--accent-strong);
      border-color: var(--accent-strong);
      background: radial-gradient(
        circle at top left,
        rgba(56, 189, 248, 0.18),
        rgba(15, 23, 42, 0.95)
      );
    }
    
    .filters-reset-btn {
      border-radius: 999px;
      border: 1px solid rgba(148, 163, 184, 0.8);
      background: rgba(15, 23, 42, 0.9);
      color: var(--text-soft);
      font-size: 0.78rem;
      padding: 4px 11px;
      cursor: pointer;
      display: inline-flex;
      align-items: center;
      gap: 6px;
      transition: background var(--transition-fast),
        transform var(--transition-fast), border-color var(--transition-fast),
        color var(--transition-fast), opacity var(--transition-fast);
    }
    
    .filters-reset-btn:hover {
      background: rgba(15, 23, 42, 0.95);
      color: var(--text);
      transform: translateY(-1px);
    }
    
    .filters-reset-btn:active {
      transform: translateY(0);
    }

    .filter-group-header {
      width: 100%;
      border: none;
      background: transparent;
      padding: 2px 2px 4px;
      display: flex;
      align-items: center;
      justify-content: space-between;
      gap: 6px;
      cursor: pointer;
    }
    
    .filter-group-header:focus-visible {
      outline: 1px solid var(--accent-strong);
      outline-offset: 2px;
    }
    
    .filter-label {
      font-size: 0.76rem;
      color: var(--text-soft);
      margin: 0;
    }
    
    .filter-group-meta {
      font-size: 0.7rem;
      color: var(--text-soft);
      opacity: 0.7;
    }
    
    .filter-chevron {
      font-size: 0.8rem;
      color: var(--text-soft);
      transition: transform var(--transition-fast), color var(--transition-fast);
    }
    
    /* Collapsible chips container */
    .filter-chips-wrapper {
      overflow: hidden;
      max-height: 0;
      transition: max-height 220ms ease;
    }
    
    /* (Optional) you can drop this, but it's harmless redundancy */
    .filter-group.collapsed .filter-chips-wrapper {
      max-height: 0;
    }
    
    .filter-group.collapsed .filter-chevron {
      transform: rotate(-90deg);
    }
    
    /* Item grid & cards */
    .items-section-header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-bottom: 10px;
      gap: 12px;
    }

    .items-section-title {
      font-size: 0.95rem;
      font-weight: 500;
      color: var(--text-soft);
    }

    .items-count {
      font-size: 0.8rem;
      color: var(--text-soft);
    }

    .items-grid {
      display: grid;
      grid-template-columns: minmax(0, 1fr);
      gap: 10px;
      align-items: flex-start;
    }

    @media (min-width: 600px) {
      .items-grid {
        grid-template-columns: repeat(2, minmax(0, 1fr));
      }
    }

    @media (min-width: 992px) {
      .items-grid {
        grid-template-columns: repeat(3, minmax(0, 1fr));
      }
    }

    .empty-state {
      margin-top: 18px;
      padding: 18px 16px;
      border-radius: var(--radius-md);
      border: 1px dashed var(--border-subtle);
      background: linear-gradient(
        135deg,
        rgba(15, 23, 42, 0.9),
        rgba(15, 23, 42, 0.98)
      );
      font-size: 0.88rem;
      color: var(--text-soft);
      display: flex;
      flex-direction: column;
      gap: 6px;
    }

    .empty-state strong {
      color: var(--text);
      font-weight: 500;
    }

    .item-card {
      position: relative;
      border-radius: var(--radius-md);
      border: 1px solid var(--border-subtle);
      background: radial-gradient(
        circle at top left,
        rgba(15, 23, 42, 0.9),
        rgba(15, 23, 42, 1)
      );
      overflow: hidden;
      cursor: pointer;
      display: flex;
      flex-direction: column;
      min-height: 170px;
      transition:
        transform var(--transition-med),
        box-shadow var(--transition-med),
        border-color var(--transition-med),
        background var(--transition-med);
    }

    .item-card:hover {
      transform: translateY(-3px);
      box-shadow: var(--shadow-subtle);
      border-color: var(--accent-strong);
    }

    .item-card-main {
      display: flex;
      gap: 10px;
      padding: 10px 10px 8px;
      transition:
        padding var(--transition-med),
        gap var(--transition-med);
    }

    .item-image-wrapper {
      width: 80px;
      height: 80px;
      flex-shrink: 0;
      border-radius: 16px;
      overflow: hidden;
      border: 1px solid rgba(148, 163, 184, 0.6);
      background: radial-gradient(circle at center, #1f2937, #020617);
      display: flex;
      align-items: center;
      justify-content: center;
      transition:
        width var(--transition-med),
        height var(--transition-med),
        transform var(--transition-med);
    }

    .item-image {
      width: 100%;
      height: 100%;
      object-fit: cover;
      display: block;
    }

    .item-main-text {
      display: flex;
      flex-direction: column;
      justify-content: space-between;
      gap: 4px;
      min-width: 0;
      flex: 1;
      transition: transform var(--transition-med);
    }

    .item-brand {
      font-size: 0.8rem;
      text-transform: uppercase;
      letter-spacing: 0.08em;
      color: var(--text-soft);
    }

    .item-model {
      font-size: 0.9rem;
      font-weight: 500;
      color: var(--text);
      transition: font-size var(--transition-med);
    }

    .item-meta-row {
      display: flex;
      justify-content: space-between;
      align-items: center;
      gap: 6px;
      margin-top: 4px;
    }

    .item-tags {
      display: flex;
      flex-wrap: wrap;
      gap: 4px;
    }

    .item-tag {
      font-size: 0.7rem;
      padding: 2px 5px;
      border-radius: 999px;
      border: 1px solid rgba(148, 163, 184, 0.5);
      color: var(--text-soft);
      background: rgba(15, 23, 42, 0.9);
    }

    .price-block {
      display: flex;
      flex-direction: column;
      align-items: flex-end;
      gap: 2px;
    }

    .item-price-full {
      font-size: 0.78rem;
      text-decoration: line-through;
      color: #fca5a5;
      opacity: 0.9;
    }

    .item-price {
      font-size: 0.9rem;
      font-weight: 600;
      color: var(--accent-strong);
      padding: 3px 8px;
      border-radius: 999px;
      background: var(--accent-soft);
      border: 1px solid rgba(56, 189, 248, 0.5);
    }

    .item-card-footer {
      padding: 0 10px 10px;
      display: flex;
      justify-content: space-between;
      align-items: center;
      font-size: 0.78rem;
      color: var(--text-soft);
      border-top: 1px dashed rgba(148, 163, 184, 0.4);
      margin-top: 4px;
      padding-top: 6px;
    }

    .item-expand-hint {
      display: inline-flex;
      align-items: center;
      gap: 4px;
      font-size: 0.76rem;
      color: var(--text-soft);
    }

    .item-expand-hint svg {
      width: 10px;
      height: 10px;
    }

    .item-id-label {
      font-size: 0.7rem;
      color: var(--text-soft);
      opacity: 0.9;
    }

    /* Expanded details (visible when card has .expanded) */
    .item-details {
      max-height: 0;
      padding: 0 10px;
      overflow: hidden;
      border-top: 1px dashed rgba(148, 163, 184, 0.4);
      transition: max-height 240ms ease, padding 240ms ease;
    }

    .item-card.expanded .item-details {
      max-height: 260px; /* enough for details & button */
      padding: 6px 10px 10px;
    }

    .details-grid {
      display: grid;
      grid-template-columns: minmax(0, 1fr);
      gap: 4px 10px;
      margin-bottom: 8px;
      margin-top: 4px;
    }

    @media (min-width: 768px) {
      .details-grid {
        grid-template-columns: repeat(2, minmax(0, 1fr));
      }
    }

    .detail-row {
      font-size: 0.78rem;
      color: var(--text-soft);
    }

    .detail-label {
      font-weight: 500;
      color: var(--text);
      margin-right: 4px;
    }

    .claim-btn {
      align-self: flex-start;
      font-size: 0.78rem;
      padding: 6px 10px;
      border-radius: 999px;
      border: none;
      background: linear-gradient(
        135deg,
        #0ea5e9,
        #22c55e
      );
      color: #0f172a;
      font-weight: 600;
      cursor: pointer;
      display: inline-flex;
      align-items: center;
      gap: 6px;
      box-shadow: 0 8px 16px rgba(8, 47, 73, 0.8);
      transition: transform var(--transition-fast),
        box-shadow var(--transition-fast), opacity var(--transition-fast);
    }

    .claim-btn:hover {
      transform: translateY(-1px);
      box-shadow: 0 12px 22px rgba(8, 47, 73, 0.9);
    }

    .claim-btn:active {
      transform: translateY(0);
      box-shadow: 0 6px 10px rgba(8, 47, 73, 0.9);
    }

    .claim-btn svg {
      width: 12px;
      height: 12px;
    }

    /* Claimed / unavailable state */
    .item-card.claimed {
      cursor: default;
      filter: grayscale(1) brightness(0.7);
      border-style: dashed;
      border-color: rgba(148, 163, 184, 0.7);
      background: radial-gradient(
        circle at top left,
        rgba(31, 41, 55, 0.9),
        rgba(15, 23, 42, 1)
      );
    }

    .item-card.claimed:hover {
      transform: none;
      box-shadow: none;
      border-color: rgba(148, 163, 184, 0.7);
    }

    .claimed-banner {
      position: absolute;
      top: 10px;
      right: -32px;
      transform: rotate(35deg);
      background: var(--danger-soft);
      color: #fecaca;
      font-size: 0.7rem;
      padding: 2px 24px;
      text-transform: uppercase;
      letter-spacing: 0.12em;
      border-top: 1px solid rgba(248, 113, 113, 0.8);
      border-bottom: 1px solid rgba(248, 113, 113, 0.8);
      pointer-events: none;
    }

    .item-card.claimed .item-expand-hint {
      opacity: 0.5;
    }

    /* Expanded card layout (desktop focus) */
    @media (min-width: 768px) {
      .item-card.expanded {
        grid-column: 1 / -1;            /* span full row */
        min-height: 260px;
        transform: translateY(-4px);
        box-shadow: var(--shadow-soft);
        border-color: var(--accent-strong);
      }
    
      .item-card.expanded:hover {
        transform: translateY(-4px);    /* avoid double-lift on hover */
      }
    
      /* Make the expanded layout vertical, with a big centered image */
      .item-card.expanded .item-card-main {
        padding: 18px 24px 14px;
        gap: 18px;
        flex-direction: column;
        align-items: center;            /* center image + text */
      }
    
      .item-card.expanded .item-image-wrapper {
        width: 260px;                   /* much wider image */
        height: 160px;
      }
    
      .item-card.expanded .item-main-text {
        align-items: center;
        text-align: center;
      }
    
      .item-card.expanded .item-meta-row {
        width: 100%;
        justify-content: space-between;
        flex-wrap: wrap;
      }
    
      .item-card.expanded .item-model {
        font-size: 1.05rem;
      }
    }


    /* Modals */
    .modal-backdrop {
      position: fixed;
      inset: 0;
      background: rgba(15, 23, 42, 0.8);
      backdrop-filter: blur(10px);
      display: none;
      align-items: center;
      justify-content: center;
      padding: 16px;
      z-index: 40;
    }

    .modal-backdrop.active {
      display: flex;
    }

    .modal {
      width: 100%;
      max-width: 480px;
      background: radial-gradient(
        circle at top left,
        #020617,
        #020617 45%,
        #020617 100%
      );
      border-radius: 20px;
      border: 1px solid rgba(148, 163, 184, 0.7);
      box-shadow: var(--shadow-soft);
      padding: 18px 18px 18px;
      position: relative;
    }

    /* Image preview modal */
    .image-modal {
      max-width: 720px;
    }

    .image-modal-body {
      display: flex;
      justify-content: center;
      align-items: center;
      padding-top: 8px;
    }

    #image-modal-img {
      max-width: 100%;
      max-height: 70vh;
      border-radius: 12px;
      border: 1px solid var(--border-subtle);
      object-fit: contain;
      background: #020617;
    }


    @media (min-width: 480px) {
      .modal {
        padding: 20px 22px 20px;
      }
    }

    .modal-header {
      display: flex;
      justify-content: space-between;
      align-items: flex-start;
      gap: 10px;
      margin-bottom: 10px;
    }

    .modal-title {
      font-size: 1rem;
      font-weight: 600;
    }

    .modal-subtitle {
      font-size: 0.82rem;
      color: var(--text-soft);
      margin-top: 4px;
    }

    .modal-close-btn {
      border-radius: 999px;
      border: 1px solid rgba(148, 163, 184, 0.7);
      width: 24px;
      height: 24px;
      display: inline-flex;
      align-items: center;
      justify-content: center;
      cursor: pointer;
      background: rgba(15, 23, 42, 0.9);
      font-size: 0.8rem;
      color: var(--text-soft);
      transition: background var(--transition-fast),
        transform var(--transition-fast);
    }

    .modal-close-btn:hover {
      background: rgba(15, 23, 42, 0.9);
      transform: translateY(-1px);
    }

    .modal-body {
      font-size: 0.85rem;
      color: var(--text-soft);
    }

    .modal-body strong {
      color: var(--text);
    }

    .modal-footer {
      margin-top: 14px;
      display: flex;
      justify-content: flex-end;
      gap: 8px;
      align-items: center;
      flex-wrap: wrap;
    }

    .input-group {
      margin-top: 8px;
      display: flex;
      flex-direction: column;
      gap: 6px;
    }

    .input-label {
      font-size: 0.78rem;
      color: var(--text-soft);
    }

    .input-field {
      width: 100%;
      border-radius: 999px;
      border: 1px solid rgba(148, 163, 184, 0.9);
      padding: 7px 12px;
      background: rgba(15, 23, 42, 0.9);
      color: var(--text);
      font-size: 0.82rem;
      transition: border-color var(--transition-fast),
        box-shadow var(--transition-fast), background var(--transition-fast);
    }

    .input-field:focus {
      outline: none;
      border-color: var(--accent-strong);
      box-shadow: 0 0 0 1px rgba(56, 189, 248, 0.8);
      background: #020617;
    }

    .input-error {
      font-size: 0.76rem;
      color: var(--danger);
      min-height: 1.1em;
    }

    .helper-text {
      font-size: 0.76rem;
      color: var(--text-soft);
      margin-top: 6px;
      line-height: 1.4;
    }

    .primary-btn,
    .secondary-btn {
      border-radius: 999px;
      padding: 6px 13px;
      font-size: 0.8rem;
      cursor: pointer;
      font-weight: 500;
      border: 1px solid transparent;
      display: inline-flex;
      align-items: center;
      gap: 6px;
      transition: transform var(--transition-fast),
        box-shadow var(--transition-fast), background var(--transition-fast),
        border-color var(--transition-fast), color var(--transition-fast),
        opacity var(--transition-fast);
    }

    .primary-btn {
      background: linear-gradient(135deg, #0ea5e9, #22c55e);
      color: #0f172a;
      border-color: rgba(56, 189, 248, 0.7);
      box-shadow: 0 10px 16px rgba(8, 47, 73, 0.9);
    }

    .primary-btn:hover {
      transform: translateY(-1px);
      box-shadow: 0 14px 22px rgba(8, 47, 73, 1);
    }

    .primary-btn:active {
      transform: translateY(0);
      box-shadow: 0 6px 12px rgba(8, 47, 73, 0.9);
    }

    .secondary-btn {
      background: rgba(15, 23, 42, 0.9);
      color: var(--text-soft);
      border-color: rgba(148, 163, 184, 0.8);
    }

    .secondary-btn:hover {
      background: rgba(15, 23, 42, 0.95);
      color: var(--text);
      transform: translateY(-1px);
    }

    .btn-disabled {
      opacity: 0.6;
      cursor: default;
      pointer-events: none;
      box-shadow: none;
      transform: none;
    }

    /* Info modal specific */
    .info-modal-body {
      font-size: 0.86rem;
      color: var(--text-soft);
      line-height: 1.45;
    }

    .info-modal-body strong {
      color: var(--text);
    }

    .info-modal-footer {
      display: flex;
      justify-content: flex-end;
      margin-top: 14px;
    }

    .badge-warning {
      display: inline-flex;
      align-items: center;
      gap: 5px;
      padding: 3px 9px;
      border-radius: 999px;
      border: 1px solid rgba(239, 68, 68, 0.7);
      background: var(--danger-soft);
      color: #fecaca;
      font-size: 0.72rem;
      text-transform: uppercase;
      letter-spacing: 0.08em;
      margin-bottom: 6px;
    }

    .loading-dot {
      width: 6px;
      height: 6px;
      border-radius: 999px;
      background: var(--accent-strong);
      box-shadow: 0 0 0 5px rgba(56, 189, 248, 0.25);
      animation: ping 1.4s cubic-bezier(0, 0, 0.2, 1) infinite;
    }

    @keyframes ping {
      0% {
        transform: scale(1);
        opacity: 1;
      }
      50% {
        transform: scale(1.6);
        opacity: 0.4;
      }
      100% {
        transform: scale(1.9);
        opacity: 0;
      }
    }

    .mono {
      font-family: ui-monospace, SFMono-Regular, Menlo, Monaco, Consolas,
        "Liberation Mono", "Courier New", monospace;
    }

    .highlight {
      color: var(--accent-strong);
      font-weight: 500;
    }
  </style>
</head>
<body>
  <div class="app-shell">
    <main class="app-card" id="app-root">
      <!-- Header / Intro -->
      <header class="header-row">
        <div class="title-block">
          <h1 class="app-title">
            RS Inventory Marketplace
            <span class="app-title-badge">Employee Edition</span>
          </h1>
      
          <p class="app-subtitle lead-subtitle">
            This is the internal RS marketplace for employees to purchase surplus
            monitors, laptops, and other equipment at special discounted pricing.
          </p>
      
          <p class="app-subtitle">
            You‚Äôre seeing the same live inventory our IT team uses before items are
            listed for general resale. Click an item to view details and, if you‚Äôre
            ready, submit a claim.
          </p>
      
          <p class="app-subtitle">
            When you claim an item, it becomes unavailable to other employees.
            Please only claim an item if you fully intend to purchase. After you
            submit your claim, you‚Äôll receive a confirmation email from Robert Slack
            IT with payment and pickup instructions.
          </p>
      
          <div class="pill-notice">
            <span class="dot"></span>
            <span>
              Availability is re-checked when you submit your claim. If someone
              claimed the same item moments before you, you‚Äôll be notified and the
              list will refresh with the latest status.
            </span>
          </div>
        </div>
      </header>

      <!-- Equipment type selector -->
      <section aria-label="Equipment type" class="type-selector" id="type-selector">
        <!-- Populated via JS using EQUIPMENT_TYPES -->
      </section>

      <!-- Filters (shown after a category is selected) -->
      <section id="filters-section" class="filters-section" style="display:none;">
        <div class="filters-header">
          <div class="filters-title">Filters</div>
          <button
            type="button"
            class="filters-reset-btn"
            id="filters-reset-btn"
          >
            <span>Reset filters</span>
          </button>
        </div>
        <div class="filters-grid" id="filters-grid">
          <!-- Populated via JS -->
        </div>
      </section>
      
      <!-- Item list / grid -->
      <section id="items-section" aria-live="polite">
        <div class="items-section-header">
          <div class="items-section-title" id="items-section-title">
            Select a category to view inventory.
          </div>
          <div class="items-count" id="items-count"></div>
        </div>
        <div class="items-grid" id="items-grid"></div>
        <div class="empty-state" id="empty-state" style="display: none;">
          <strong>No items found for this category.</strong>
          <span>
            If you believe this is incorrect, please refresh your browser or
            contact IT.
          </span>
        </div>
      </section>
    </main>
  </div>

  <!-- Claim form modal -->
  <div class="modal-backdrop" id="claim-modal-backdrop" aria-hidden="true">
    <div class="modal" role="dialog" aria-modal="true" aria-labelledby="claim-modal-title">
      <div class="modal-header">
        <div>
          <div class="modal-title" id="claim-modal-title">Claim this item</div>
          <div class="modal-subtitle" id="claim-modal-subtitle">
            You‚Äôre about to claim <span class="highlight" id="claim-item-name"></span>.
          </div>
        </div>
        <button type="button" class="modal-close-btn" id="claim-modal-close-btn" aria-label="Close">
          ‚úï
        </button>
      </div>
      <div class="modal-body">
        <div class="input-group">
          <label class="input-label" for="claim-name-input">Your name</label>
          <input
            id="claim-name-input"
            type="text"
            class="input-field"
            autocomplete="name"
            placeholder="e.g. Jane Doe"
          />
        </div>

        <div class="input-group">
          <label class="input-label" for="claim-email-input"
            >Robert Slack email address</label
          >
          <input
            id="claim-email-input"
            type="email"
            class="input-field"
            autocomplete="email"
            placeholder="you@robertslack.com"
          />
          <div class="input-error" id="claim-error"></div>
        </div>

        <p class="helper-text">
          <strong>Important:</strong> Please use your Robert Slack email address
          ending in <span class="mono">@robertslack.com</span>.
        </p>
        <p class="helper-text">
          By clicking submit, this item will become unavailable to other
          employees.
        </p>
      </div>
      <div class="modal-footer">
        <button type="button" class="secondary-btn" id="claim-cancel-btn">Cancel</button>
        <button type="button" class="primary-btn" id="claim-submit-btn">
          <span>Submit</span>
        </button>
      </div>
    </div>
  </div>

  <!-- Info / status modal -->
  <div class="modal-backdrop" id="info-modal-backdrop" aria-hidden="true">
    <div class="modal" role="dialog" aria-modal="true" aria-labelledby="info-modal-title">
      <div class="modal-header">
        <div>
          <div class="modal-title" id="info-modal-title">Status</div>
        </div>
      </div>
      <div class="modal-body">
        <div id="info-modal-content" class="info-modal-body">
          <!-- Filled dynamically -->
        </div>
        <div class="info-modal-footer">
          <button type="button" class="primary-btn" id="info-modal-ok-btn">
            <span>OK</span>
          </button>
        </div>
      </div>
    </div>
  </div>
  <!-- Image preview modal -->
  <div class="modal-backdrop" id="image-modal-backdrop" aria-hidden="true">
    <div class="modal image-modal" role="dialog" aria-modal="true" aria-labelledby="image-modal-title">
      <div class="modal-header">
        <div class="modal-title" id="image-modal-title">Item photo</div>
        <button
          type="button"
          class="modal-close-btn"
          id="image-modal-close-btn"
          aria-label="Close image preview"
        >
          ‚úï
        </button>
      </div>
      <div class="modal-body image-modal-body">
        <img id="image-modal-img" alt="Full-size item image" />
      </div>
    </div>
  </div>

  <script>
    // ================================================================
    // CONFIGURATION
    // ================================================================
    const INVENTORY_URL =
      "https://api.jsonbin.io/v3/b/6930af4443b1c97be9d5f2f3/latest"; // JSONBin endpoint
    const IMAGE_BASE_PATH = "images/"; // base folder for images
    const FULL_IMAGE_BASE_PATH = "images-full/"; // folder for full-size images (modal only)
    
    // JSONBin auth headers (‚ö† these are visible to anyone who can see the page source)
    const JSONBIN_HEADERS = {
      "X-Master-Key": "$2a$10$gP/pHtjcvuTYA4hrwnrjs.1lzggrBo859SIUtJLqHFuivlZ4wNP82",
      "X-ACCESS-KEY": "$2a$10$ALp7G2o1BOTQghlOa2V5NevG/.iYUICeMqAxkHEZHauOV16BVR2sG",
    };


    // Equipment types shown as chips at the top.
    // To add more, just extend this array.
    const EQUIPMENT_TYPES = [
      {
        id: "monitor",
        label: "Monitor",
        icon: "üñ•Ô∏è",
        matches: ["monitor"],
      },
      {
        id: "aio",
        label: "Computer All-In-One",
        icon: "üß†",
        matches: ["all in one", "all-in-one", "aio"],
      },
      {
        id: "laptop",
        label: "Laptop",
        icon: "üíª",
        matches: ["laptop", "notebook", "computer laptop"],
      },
    ];

    // Placeholder images by normalized equipment type
    const PLACEHOLDER_IMAGES = {
      monitor: "monitor.png",
      aio: "AIO.png",
      laptop: "Laptop.png",
    };

    // Pipedream endpoint to receive claim details
    const CLAIM_WEBHOOK_URL = "https://eocwkyw5bh39tkn.m.pipedream.net";

    // ================================================================
    // STATE
    // ================================================================
    let allItems = [];
    let filteredItems = [];
    let selectedTypeId = null;
    let currentItemForClaim = null;
    let isSubmitting = false;
    const activeFilters = {
      size: new Set(),
      resolution: new Set(),
      aspectRatio: new Set(),
      brand: new Set(),
    };

    // Track which groups are collapsed (true = collapsed)
    const filterGroupState = {
      size: true,
      resolution: true,
      aspectRatio: true,
      brand: true,
    };


    // DOM references
    const typeSelectorEl = document.getElementById("type-selector");
    const itemsGridEl = document.getElementById("items-grid");
    const itemsSectionTitleEl = document.getElementById("items-section-title");
    const itemsCountEl = document.getElementById("items-count");
    const emptyStateEl = document.getElementById("empty-state");
    const filtersSectionEl = document.getElementById("filters-section");
    const filtersGridEl = document.getElementById("filters-grid");
    const filtersResetBtn = document.getElementById("filters-reset-btn");

    const claimModalBackdrop = document.getElementById("claim-modal-backdrop");
    const claimItemNameEl = document.getElementById("claim-item-name");
    const claimModalSubTitle = document.getElementById("claim-modal-subtitle");
    const claimNameInput = document.getElementById("claim-name-input");
    const claimEmailInput = document.getElementById("claim-email-input");
    const claimErrorEl = document.getElementById("claim-error");
    const claimSubmitBtn = document.getElementById("claim-submit-btn");
    const claimCancelBtn = document.getElementById("claim-cancel-btn");
    const claimModalCloseBtn = document.getElementById("claim-modal-close-btn");

    const infoModalBackdrop = document.getElementById("info-modal-backdrop");
    const infoModalTitle = document.getElementById("info-modal-title");
    const infoModalContent = document.getElementById("info-modal-content");
    const infoModalOkBtn = document.getElementById("info-modal-ok-btn");
    const imageModalBackdrop = document.getElementById("image-modal-backdrop");
    const imageModalImg = document.getElementById("image-modal-img");
    const imageModalCloseBtn = document.getElementById("image-modal-close-btn");
    
    // ================================================================
    // HELPER FUNCTIONS: Data access / normalization
    // ================================================================

    /**
     * Safely extract a field from an item using multiple possible property names.
     * This makes the app resilient to CSV-to-JSON header variations.
     */
    function getField(item, ...candidates) {
      for (const key of candidates) {
        if (Object.prototype.hasOwnProperty.call(item, key) && item[key] != null && item[key] !== "") {
          return item[key];
        }
      }
      return "";
    }

    /**
     * Get the normalized equipment type string from an item.
     */
    function getEquipmentTypeRaw(item) {
      return (
        getField(item, "EquipmentType", "Equipment Type", "equipmentType")
          .toString()
          .trim() || ""
      );
    }

    /**
     * Map the raw equipment type into one of our configured type IDs (monitor/aio/laptop),
     * based on substring matches defined in EQUIPMENT_TYPES.
     */
    function getNormalizedTypeId(item) {
      const raw = getEquipmentTypeRaw(item).toLowerCase();
      for (const type of EQUIPMENT_TYPES) {
        for (const match of type.matches) {
          if (raw.includes(match)) {
            return type.id;
          }
        }
      }
      return null;
    }

    /**
     * Get the item ID (string).
     */
    function getItemId(item) {
      const idValue = getField(item, "ID", "Id", "id");
      return idValue ? String(idValue) : "";
    }

    /**
     * Build a user-facing title for the item:
     * Brand + Model + Size (if present).
     */
    function getItemTitle(item) {
      const brand = getField(item, "Brand", "brand");
      const name = getField(item, "Name", "name");
      const model = getField(item, "Model", "model", "Model/Size", "ModelSize");
      const size = getField(item, "Size", "size");
    
      // Prefer Name when present, fall back to Model
      const primary = name || model;
      return [brand, primary, size].filter(Boolean).join(" ");
    }


    /**
     * Get the employee-facing price from EmployeePricing (or fallbacks).
     * Your CSV uses EmployeePricing and the values already include "$".
     */
    function getEmployeePrice(item) {
      const raw = getField(
        item,
        "EmployeePricing",   // <-- your CSV header
        "EmployeePrice",
        "Employee Price",
        "employeePrice",
        "employee_price"
      );

      if (!raw) return "";

      const trimmed = String(raw).trim();
      if (!trimmed) return "";

      // If the string starts with "$", use as-is.
      // Otherwise, prepend "$".
      return trimmed.startsWith("$") ? trimmed : `$${trimmed}`;
    }

    /**
     * Get the full/original price (for strike-through) from " Price " / Price.
     */
    function getFullPrice(item) {
      const raw = getField(
        item,
        " Price ",      // <-- your CSV has this with spaces
        "FullPrice",
        "Full Price",
        "Price",
        "price"
      );

      if (!raw) return "";

      const trimmed = String(raw).trim();
      if (!trimmed) return "";

      return trimmed.startsWith("$") ? trimmed : `$${trimmed}`;
    }

    /**
     * Get availability ("y"/"n") normalized from the "Available" field.
     * Default assumption: available (y) if unknown.
     */
    function isItemAvailable(item) {
      const availableRaw = getField(item, "Available", "available")
        .toString()
        .trim()
        .toLowerCase();

      if (availableRaw === "n" || availableRaw === "no") return false;
      if (availableRaw === "y" || availableRaw === "yes") return true;

      // If field is missing or unrecognized, treat as available.
      return true;
    }

    /**
     * Extract details for the expanded section (non-blank values only).
     */
    function getItemDetails(item) {
      return {
        Model: getField(item, "Model", "model", "Model/Size", "ModelSize"),
        SerialNumber: getField(
          item,
          "SerialNumber",
          "Serial Number",
          "Serial",
          "serial"
        ),
        Condition: getField(item, "Condition", "condition"),
        Processor: getField(item, "Processor", "CPU", "processor"),
        RAM: getField(item, "RAM", "ram", "Memory", "memory"),
        Storage: getField(item, "Storage", "storage", "Drive", "drive"),
      };
    }

    function normalizeAspectRatio(raw) {
      if (!raw) return "";
      const str = String(raw).trim();
      const match = str.match(/^(\d+)\s*:\s*(\d+)$/);
      if (!match) return str;
    
      const first = match[1];
      let second = match[2].replace(/^0+/, ""); // remove leading zeros
      if (second === "") second = "0";
    
      return `${first}:${second}`;
    }

    /**
     * Filter out empty fields from an object (used for POST payload).
     */
    function removeEmptyFields(obj) {
      const result = {};
      for (const [key, value] of Object.entries(obj || {})) {
        if (value === null || value === undefined) continue;
        if (typeof value === "string" && value.trim() === "") continue;
        result[key] = value;
      }
      return result;
    }

    function buildFilterOptions(items) {
      const options = {
        size: new Set(),
        resolution: new Set(),
        aspectRatio: new Set(),
        brand: new Set(),
      };
    
      for (const item of items) {
        const size = getField(item, "Size", "size");
        if (size) options.size.add(String(size));
    
        const resolution = getField(item, "Resolution", "resolution");
        if (resolution) options.resolution.add(String(resolution));
    
        const aspectRaw = getField(
          item,
          "AspectRatio",
          "Aspect Ratio",
          "aspectRatio",
          "aspect_ratio"
        );
        const aspect = normalizeAspectRatio(aspectRaw);
        if (aspect) options.aspectRatio.add(String(aspect));
    
        const brand = getField(item, "Brand", "brand");
        if (brand) options.brand.add(String(brand));
      }
    
      return {
        size: Array.from(options.size).sort(),
        resolution: Array.from(options.resolution).sort(),
        aspectRatio: Array.from(options.aspectRatio).sort(),
        brand: Array.from(options.brand).sort(),
      };
    }
    
    function hasActiveFilters() {
      return (
        activeFilters.size.size ||
        activeFilters.resolution.size ||
        activeFilters.aspectRatio.size ||
        activeFilters.brand.size
      );
    }
    
    function applyFilters(items) {
      if (!hasActiveFilters()) return items;
    
      return items.filter((item) => {
        const sizeVal = String(getField(item, "Size", "size") || "");
        const resVal = String(getField(item, "Resolution", "resolution") || "");
        const aspectRaw = getField(
          item,
          "AspectRatio",
          "Aspect Ratio",
          "aspectRatio",
          "aspect_ratio"
        );
        const aspectVal = String(normalizeAspectRatio(aspectRaw) || "");
        const brandVal = String(getField(item, "Brand", "brand") || "");
    
        if (activeFilters.size.size && !activeFilters.size.has(sizeVal)) return false;
        if (
          activeFilters.resolution.size &&
          !activeFilters.resolution.has(resVal)
        )
          return false;
        if (
          activeFilters.aspectRatio.size &&
          !activeFilters.aspectRatio.has(aspectVal)
        )
          return false;
        if (activeFilters.brand.size && !activeFilters.brand.has(brandVal))
          return false;
    
        return true;
      });
    }

    function toggleFilterGroup(key) {
      if (!(key in filterGroupState)) return;
    
      // Flip state
      const newCollapsed = !filterGroupState[key];
      filterGroupState[key] = newCollapsed;
    
      if (!filtersGridEl) return;
    
      const groupEl = filtersGridEl.querySelector(
        `.filter-group[data-filter-group="${key}"]`
      );
      if (!groupEl) return;
    
      const wrapper = groupEl.querySelector(".filter-chips-wrapper");
      const chevron = groupEl.querySelector(".filter-chevron");
      if (!wrapper) return;
    
      if (newCollapsed) {
        // Collapse: from current height -> 0
        wrapper.style.maxHeight = wrapper.scrollHeight + "px";
        // Force reflow so the browser registers the starting height
        void wrapper.offsetHeight;
        wrapper.style.maxHeight = "0px";
        groupEl.classList.add("collapsed");
        if (chevron) chevron.textContent = "‚ñæ";  // down when collapsed
      } else {
        // Expand: from 0 -> content height
        groupEl.classList.remove("collapsed");
        wrapper.style.maxHeight = wrapper.scrollHeight + "px";
        if (chevron) chevron.textContent = "‚ñ¥";  // up when expanded
      }
    }


    
    function resetFilters(shouldRerender = true) {
      activeFilters.size.clear();
      activeFilters.resolution.clear();
      activeFilters.aspectRatio.clear();
      activeFilters.brand.clear();
    
      if (filtersResetBtn) {
        filtersResetBtn.style.visibility = "hidden";
      }
    
      if (shouldRerender) {
        renderItems();
      }
    }
    
    function renderFilters(itemsForType) {
      if (!filtersSectionEl || !filtersGridEl) return;
    
      const { size, resolution, aspectRatio, brand } = buildFilterOptions(itemsForType);
      const hasAny =
        size.length || resolution.length || aspectRatio.length || brand.length;
    
      if (!hasAny || !selectedTypeId) {
        filtersSectionEl.style.display = "none";
        filtersGridEl.innerHTML = "";
        resetFilters(false);
        return;
      }
    
      filtersSectionEl.style.display = "flex";
    
      const groupsConfig = [
        { key: "size", label: "Size", values: size },
        { key: "resolution", label: "Resolution", values: resolution },
        { key: "aspectRatio", label: "Aspect ratio", values: aspectRatio },
        { key: "brand", label: "Brand", values: brand },
      ];
    
      let html = "";
      groupsConfig.forEach(({ key, label, values }) => {
        if (!values.length) return;
    
        const isCollapsed = !!filterGroupState[key] ?? true;
        const chevronChar = isCollapsed ? "‚ñæ" : "‚ñ¥";
        html += `
          <div class="filter-group ${isCollapsed ? "collapsed" : ""}" data-filter-group="${key}">
            <button type="button"
                    class="filter-group-header"
                    data-filter-toggle="${key}">
              <span class="filter-label">${label}</span>
              <span class="filter-group-meta">${values.length} option${values.length === 1 ? "" : "s"}</span>
              <span class="filter-chevron" aria-hidden="true">${chevronChar}</span>
            </button>
            <div class="filter-chips-wrapper">
              <div class="filter-chips">
                ${values
                  .map((value) => {
                    const stringVal = String(value);
                    const isActive = activeFilters[key].has(stringVal);
                    return `
                      <button type="button"
                              class="filter-chip${isActive ? " active" : ""}"
                              data-filter-key="${key}"
                              data-filter-value="${stringVal.replace(/"/g, "&quot;")}">
                        <span>${stringVal}</span>
                      </button>
                    `;
                  })
                  .join("")}
              </div>
            </div>
          </div>
        `;
      });
    
      filtersGridEl.innerHTML = html;
    
      if (filtersResetBtn) {
        filtersResetBtn.style.visibility = hasActiveFilters() ? "visible" : "hidden";
      }
    }

    
    function toggleFilter(key, value) {
      const set = activeFilters[key];
      if (!set) return;
    
      const stringVal = String(value);
      if (set.has(stringVal)) {
        set.delete(stringVal);
      } else {
        set.add(stringVal);
      }
    
      renderItems();
    }


    // ================================================================
    // IMAGE HANDLING
    // ================================================================

    /**
     * Set the image source for an item, attempting:
     *   1) {ID}.jpg
     *   2) {ID}.png
     *   3) {ID}.img
     *   4) Placeholder by equipment type
     */
    function setItemImage(imgEl, item) {
      const id = getItemId(item);
      const typeId = getNormalizedTypeId(item) || "monitor"; // fallback
      const placeholderFile = PLACEHOLDER_IMAGES[typeId] || PLACEHOLDER_IMAGES.monitor;

      const candidates = [
        id ? `${IMAGE_BASE_PATH}${id}.jpg` : null,
        id ? `${IMAGE_BASE_PATH}${id}.png` : null,
        id ? `${IMAGE_BASE_PATH}${id}.img` : null,
        id ? `${IMAGE_BASE_PATH}${id}.jpeg` : null,
      ].filter(Boolean);

      let index = 0;

      function tryNext() {
        if (index < candidates.length) {
          imgEl.src = candidates[index++];
        } else {
          // Fallback to generic placeholder by type
          imgEl.src = `${IMAGE_BASE_PATH}${placeholderFile}`;
        }
      }

      imgEl.onerror = tryNext;
      tryNext();
    }

    /**
     * Given a thumbnail src (usually under /images/), return the corresponding
     * full-size image path under /images-full/.
     * If no match is found, we just return the original src.
     */
    function getFullImageSrcFromThumb(src) {
      if (!src) return src;

      // Handle absolute or relative URLs that contain the IMAGE_BASE_PATH
      if (src.includes("/" + IMAGE_BASE_PATH)) {
        return src.replace("/" + IMAGE_BASE_PATH, "/" + FULL_IMAGE_BASE_PATH);
      }
      if (src.includes(IMAGE_BASE_PATH)) {
        return src.replace(IMAGE_BASE_PATH, FULL_IMAGE_BASE_PATH);
      }

      // Fallback: return the original src
      return src;
    }

    
    // ================================================================
    // RENDERING
    // ================================================================

    /**
     * Build the equipment type chips UI.
     */
    function renderTypeSelector() {
      typeSelectorEl.innerHTML = "";
      EQUIPMENT_TYPES.forEach((type, idx) => {
        const chip = document.createElement("button");
        chip.type = "button";
        chip.className =
          "type-chip" +
          (selectedTypeId === type.id || (!selectedTypeId && idx === 0)
            ? " active"
            : "");
        chip.dataset.typeId = type.id;
        chip.innerHTML = `
          <span class="icon">${type.icon}</span>
          <span>${type.label}</span>
          <span class="type-chip-badge" data-chip-count="${type.id}">--</span>
        `;
        typeSelectorEl.appendChild(chip);
      });
    }

    /**
     * Calculate counts per equipment type for chip badges.
     */
    function updateTypeCounts() {
      const counts = {};
      EQUIPMENT_TYPES.forEach((type) => {
        counts[type.id] = 0;
      });
      for (const item of allItems) {
        const typeId = getNormalizedTypeId(item);
        if (typeId && counts.hasOwnProperty(typeId)) {
          counts[typeId] += 1;
        }
      }
      // Assign counts into chip badges
      EQUIPMENT_TYPES.forEach((type) => {
        const badge = typeSelectorEl.querySelector(
          `.type-chip-badge[data-chip-count="${type.id}"]`
        );
        if (badge) {
          badge.textContent = counts[type.id] || 0;
        }
      });
    }

    /**
     * Render the grid of cards for the currently selected type.
     * Cards show:
     *   - Brand (top label)
     *   - Model + Size
     *   - Tags including Size, equipment type, availability
     *   - Full price (strike-through) and EmployeePricing side-by-side
     */
    function renderItems() {
      itemsGridEl.innerHTML = "";
      emptyStateEl.style.display = "none";

      if (!selectedTypeId) {
        itemsSectionTitleEl.textContent = "Select a category to view inventory.";
        itemsCountEl.textContent = "";
        if (filtersSectionEl) {
          filtersSectionEl.style.display = "none";
        }
        return;
      }


      const itemsForType = allItems.filter(
        (item) => getNormalizedTypeId(item) === selectedTypeId
      );

      // Build and show filter chips for this type
      renderFilters(itemsForType);

      // Apply active filters
      filteredItems = applyFilters(itemsForType);

      const typeConfig = EQUIPMENT_TYPES.find((t) => t.id === selectedTypeId);
      const typeLabel = typeConfig ? typeConfig.label : "Selected category";

      itemsSectionTitleEl.textContent = `${typeLabel} inventory`;
      itemsCountEl.textContent = `${filteredItems.length} item${
        filteredItems.length === 1 ? "" : "s"
      }`;


      if (!filteredItems.length) {
        emptyStateEl.style.display = "block";
        return;
      }

      for (const item of filteredItems) {
        const itemId = getItemId(item);
        const available = isItemAvailable(item);
        const typeRaw = getEquipmentTypeRaw(item);
        const brand = getField(item, "Brand", "brand");
        const name = getField(item, "Name", "name");
        const model = getField(item, "Model", "model");
        const size = getField(item, "Size", "size");
        const resolution = getField(item, "Resolution", "resolution");
        const aspectRatioRaw = getField(
          item,
          "AspectRatio",
          "Aspect Ratio",
          "aspectRatio",
          "aspect_ratio"
        );
        const aspectRatio = normalizeAspectRatio(aspectRatioRaw);
        
        // Use the same logic as getItemTitle: prefer Name when present
        const titlePrimary = name || model;
        const title = [brand, titlePrimary, size].filter(Boolean).join(" ");
        
        const employeePrice = getEmployeePrice(item);
        const fullPrice = getFullPrice(item);

        // Build card
        const card = document.createElement("article");
        card.className = "item-card" + (available ? "" : " claimed");
        if (itemId) card.dataset.itemId = itemId;

        card.innerHTML = `
          ${!available ? `<div class="claimed-banner">CLAIMED</div>` : ""}
          <div class="item-card-main">
            <div class="item-image-wrapper">
              <img class="item-image" alt="Item image for ${title || "inventory item"}" />
            </div>
            <div class="item-main-text">
              <div>
                <div class="item-brand">${brand || typeRaw || "Equipment"}</div>
                <div class="item-model">
                  ${(name || model || "(Unnamed item)")}${size ? ` ‚Äî ${size}` : ""}
                </div>
              </div>
              <div class="item-meta-row">
                <div class="item-tags">
                  ${
                    available
                      ? `<span class="item-tag">Available</span>`
                      : `<span class="item-tag">Not available</span>`
                  }
                  ${size ? `<span class="item-tag">Size: ${size}</span>` : ""}
                  ${resolution ? `<span class="item-tag">Resolution: ${resolution}</span>` : ""}
                  ${aspectRatio ? `<span class="item-tag">Aspect ratio: ${aspectRatio}</span>` : ""}
                  ${typeRaw ? `<span class="item-tag">${typeRaw}</span>` : ""}
                </div>
                ${
                  fullPrice || employeePrice
                    ? `<div class="price-block">
                         ${
                           fullPrice
                             ? `<div class="item-price-full">${fullPrice}</div>`
                             : ""
                         }
                         ${
                           employeePrice
                             ? `<div class="item-price">${employeePrice}</div>`
                             : ""
                         }
                       </div>`
                    : `<div class="item-price" style="opacity:0.7;">Price TBD</div>`
                }
              </div>
            </div>
          </div>
          <div class="item-card-footer">
            <div class="item-expand-hint">
              <svg viewBox="0 0 20 20" aria-hidden="true">
                <path fill="currentColor" d="M5 7l5 5 5-5H5z"></path>
              </svg>
              <span>Click for details</span>
            </div>
            ${
              itemId
                ? `<div class="item-id-label">ID: <span class="mono">${itemId}</span></div>`
                : `<div class="item-id-label"></div>`
            }
          </div>
          <div class="item-details">
            <div class="details-grid">
              <!-- Filled in JS with non-blank details -->
            </div>
            ${
              available
                ? `<button type="button" class="claim-btn" data-claim-id="${itemId}">
                     <span>Claim this item</span>
                     <svg viewBox="0 0 20 20" aria-hidden="true">
                       <path fill="currentColor"
                         d="M8.5 13.5L5 10l1.4-1.4 2.1 2.1L13.6 5l1.4 1.4z" />
                     </svg>
                   </button>`
                : `<span style="font-size:0.76rem;color:var(--text-soft);">
                     This item has already been claimed.
                   </span>`
            }
          </div>
        `;

        // Attach image
        const img = card.querySelector(".item-image");
        setItemImage(img, item);

        // Fill expanded details with non-blank values
        const details = getItemDetails(item);
        const detailsGridEl = card.querySelector(".details-grid");
        Object.entries(details).forEach(([label, value]) => {
          if (!value) return;
          const row = document.createElement("div");
          row.className = "detail-row";
          row.innerHTML = `<span class="detail-label">${label}:</span><span>${value}</span>`;
          detailsGridEl.appendChild(row);
        });

        itemsGridEl.appendChild(card);
      }
    }

    /**
     * Update UI for selected type chip.
     */
    function updateActiveChip() {
      const chips = typeSelectorEl.querySelectorAll(".type-chip");
      chips.forEach((chip) => {
        chip.classList.toggle(
          "active",
          chip.dataset.typeId === selectedTypeId
        );
      });
    }

    // ================================================================
    // MODALS
    // ================================================================

    function openClaimModal(item) {
      currentItemForClaim = item || null;
      claimErrorEl.textContent = "";
      claimNameInput.value = "";
      claimEmailInput.value = "";

      const title = getItemTitle(item);
      const employeePrice = getEmployeePrice(item);
      const fullPrice = getFullPrice(item);
      claimItemNameEl.textContent = title || "this item";

      const id = getItemId(item);
      let subtitleText = "You‚Äôre about to claim ";
      if (title) subtitleText += title;
      else subtitleText += "this item";
      if (id) subtitleText += ` (ID: ${id})`;

      const priceLabel = employeePrice || fullPrice;
      if (priceLabel) {
        subtitleText += ` for ${priceLabel}.`;
      }

      claimModalSubTitle.innerHTML = subtitleText;

      claimModalBackdrop.classList.add("active");
      claimModalBackdrop.setAttribute("aria-hidden", "false");
      // Focus the name field for convenience
      setTimeout(() => claimNameInput.focus(), 50);
    }

    function closeClaimModal() {
      claimModalBackdrop.classList.remove("active");
      claimModalBackdrop.setAttribute("aria-hidden", "true");
      currentItemForClaim = null;
      isSubmitting = false;
      claimSubmitBtn.classList.remove("btn-disabled");
    }

    /**
     * Show an informational modal.
     * options:
     *   - title: string
     *   - contentHtml: string
     *   - autoReload: boolean
     *   - reloadDelayMs: number
     *   - hideOkButton: boolean
     */
    function openInfoModal(options = {}) {
      const {
        title = "Status",
        contentHtml = "",
        autoReload = false,
        reloadDelayMs = 5000,
        hideOkButton = false,
      } = options;

      infoModalTitle.textContent = title;
      infoModalContent.innerHTML = contentHtml;
      infoModalOkBtn.style.display = hideOkButton ? "none" : "inline-flex";

      infoModalBackdrop.classList.add("active");
      infoModalBackdrop.setAttribute("aria-hidden", "false");

      if (autoReload) {
        setTimeout(() => {
          window.location.reload();
        }, reloadDelayMs);
      }
    }

    function closeInfoModal() {
      infoModalBackdrop.classList.remove("active");
      infoModalBackdrop.setAttribute("aria-hidden", "true");
    }

    function openImageModal(src, altText) {
      if (!imageModalBackdrop || !imageModalImg) return;

      const fullSrc = getFullImageSrcFromThumb(src);
      imageModalImg.src = fullSrc;
      imageModalImg.alt = altText || "Item image";

      imageModalBackdrop.classList.add("active");
      imageModalBackdrop.setAttribute("aria-hidden", "false");
    }


    function closeImageModal() {
      if (!imageModalBackdrop || !imageModalImg) return;
      imageModalBackdrop.classList.remove("active");
      imageModalBackdrop.setAttribute("aria-hidden", "true");
      imageModalImg.src = "";
    }

    // ================================================================
    // DATA LOADING
    // ================================================================

    /**
     * Fetch inventory.json from server.
     */
    async function fetchInventory() {
      const response = await fetch(INVENTORY_URL, {
        method: "GET",
        headers: JSONBIN_HEADERS,
        cache: "no-store", // always hit network; don't use browser cache
      });
    
      if (!response.ok) {
        throw new Error(`Failed to load inventory (${response.status})`);
      }
    
      const data = await response.json();
    
      // JSONBin v3 usually returns:
      // { record: <storedData>, metadata: { ... } }
      // In your case, <storedData> should be the array.
      // But we also defensively handle the old nested shape.
      let record = null;
    
      if (Array.isArray(data?.record?.record)) {
        // Old nested shape: { record: { record: [ ... ] }, metadata: { ... } }
        record = data.record.record;
      } else if (Array.isArray(data?.record)) {
        // Normal shape: { record: [ ... ], metadata: { ... } }
        record = data.record;
      } else if (Array.isArray(data)) {
        // Fallback: bin directly stores the array
        record = data;
      }
    
      if (!Array.isArray(record)) {
        throw new Error("Inventory payload must be a JSON array of items");
      }
    
      return record;
    }



    /**
     * Initial load:
     *  - fetch inventory.json
     *  - render items (checking Available field to gray out "n")
     */
    async function loadInitialInventory() {
      try {
        allItems = await fetchInventory();
      } catch (error) {
        console.error("Error loading inventory:", error);
        openInfoModal({
          title: "Unable to load inventory",
          contentHtml:
            "<p>We couldn't load the inventory file. Please try refreshing this page or contact IT if the issue continues.</p>",
        });
        return;
      }

      // Default selected type is first configured type
      if (!selectedTypeId && EQUIPMENT_TYPES.length > 0) {
        selectedTypeId = EQUIPMENT_TYPES[0].id;
      }

      renderTypeSelector();
      updateTypeCounts();
      renderItems();
    }

    /**
     * Fetch the latest inventory and return the item matching the given ID.
     * Used for concurrency checking on claim/submit.
     * This function re-reads inventory.json every time and re-renders.
     */
    async function refreshAndGetItemById(itemId) {
      const latestInventory = await fetchInventory();
      allItems = latestInventory; // update in-memory reference
      updateTypeCounts();
      renderItems(); // keep UI in sync with latest availability

      return latestInventory.find(
        (item) => String(getItemId(item)) === String(itemId)
      );
    }

    // ================================================================
    // CLAIM FLOW
    // ================================================================

    /**
     * Validate that the email ends with "@robertslack.com".
     */
    function isValidRsEmail(email) {
      if (!email) return false;
      const trimmed = email.trim().toLowerCase();
      return trimmed.endsWith("@robertslack.com");
    }

    /**
     * Handle "Claim this item" button click.
     * 1) Re-load inventory and check if item is still available (by ID).
     * 2) If claimed, show "someone else got it" modal and reload.
     * 3) If available, open the claim modal.
     */
    async function handleClaimButtonClick(itemId) {
      if (!itemId) return;

      try {
        const item = await refreshAndGetItemById(itemId);

        if (!item) {
          openInfoModal({
            title: "Item not found",
            contentHtml:
              "<p>We couldn't find this item in the current inventory. It may have been removed or updated.</p>",
          });
          return;
        }

        if (!isItemAvailable(item)) {
          openInfoModal({
            title: "Already claimed",
            contentHtml:
              '<div class="badge-warning"><span>Heads up</span></div>' +
              "<p>Sorry! Another employee just claimed this item. We'll refresh the page so that you can continue browsing.</p>",
            autoReload: true,
            hideOkButton: true,
          });
          return;
        }

        // Still available ‚Äî proceed to claim modal
        openClaimModal(item);
      } catch (error) {
        console.error("Error during claim availability check:", error);
        openInfoModal({
          title: "Something went wrong",
          contentHtml:
            "<p>We couldn't confirm the current availability of this item. Please try again in a moment or contact IT.</p>",
        });
      }
    }

    /**
     * Handle final "Submit" in the claim modal.
     * 1) Validate inputs.
     * 2) Re-load inventory & confirm item is still available (by ID).
     * 3) POST claim details to Pipedream endpoint.
     * 4) Show confirmation & reload.
     */
    async function handleSubmitClaim() {
      if (!currentItemForClaim || isSubmitting) return;

      const name = claimNameInput.value.trim();
      const email = claimEmailInput.value.trim();

      // Basic validation
      if (!name) {
        claimErrorEl.textContent = "Please enter your name.";
        return;
      }
      if (!email) {
        claimErrorEl.textContent = "Please enter your email address.";
        return;
      }
      if (!isValidRsEmail(email)) {
        claimErrorEl.textContent =
          "Please enter your email address ending in robertslack.com.";
        return;
      }

      claimErrorEl.textContent = "";
      isSubmitting = true;
      claimSubmitBtn.classList.add("btn-disabled");

      const itemId = getItemId(currentItemForClaim);

      try {
        // Re-check latest availability (re-read inventory.json)
        const latestItem = await refreshAndGetItemById(itemId);
        if (!latestItem || !isItemAvailable(latestItem)) {
          closeClaimModal();
          openInfoModal({
            title: "Already claimed",
            contentHtml:
              '<div class="badge-warning"><span>Heads up</span></div>' +
              "<p>Sorry! Another employee just claimed this item. We'll refresh the page so that you can continue browsing.</p>",
            autoReload: true,
            hideOkButton: true,
          });
          return;
        }

        // Build payload with all non-blank inventory values + claimer metadata
        const cleanedItemData = removeEmptyFields(latestItem);
        const payload = {
          claimerName: name,
          claimerEmail: email,
          claimTimestamp: new Date().toISOString(),
          source: "rs-inventory-app",
          ...cleanedItemData,
        };

        // Send to Pipedream
        try {
          const response = await fetch(CLAIM_WEBHOOK_URL, {
            method: "POST",
            mode: "cors",
            headers: {
              "Content-Type": "application/json"
            },
            body: JSON.stringify(payload)
          });
        
          if (!response.ok) {
            throw new Error("Failed to submit claim.");
          }
        } catch (postError) {
          // Even if POST fails, show a generic message; Pipedream logs can be checked separately.
          console.error("Error posting claim to webhook:", postError);
        }

        // Success UI ‚Äî close claim modal, open info modal, then reload after 5s
        closeClaimModal();
        openInfoModal({
          title: "Claimed!",
          contentHtml:
            "<p>Claimed! You'll receive an email confirmation with more info regarding this item. Returning you to the home screen...</p>" +
            '<p class="helper-text" style="margin-top:8px;">' +
            "Please note that due to limitations in this application, there is a very small chance that someone else may have claimed this item " +
            "during the time you have been on this page. If so, we will notify you momentarily." +
            "</p>",
          autoReload: true,
          reloadDelayMs: 5000,
          hideOkButton: true,
        });
      } catch (error) {
        console.error("Error submitting claim:", error);
        isSubmitting = false;
        claimSubmitBtn.classList.remove("btn-disabled");
        openInfoModal({
          title: "Something went wrong",
          contentHtml:
            "<p>We couldn't complete your claim due to an unexpected error. Please try again in a moment.</p>",
        });
      }
    }

    // ================================================================
    // EVENT LISTENERS
    // ================================================================

    // Equipment type chips
    typeSelectorEl.addEventListener("click", (event) => {
      const chip = event.target.closest(".type-chip");
      if (!chip) return;
      const typeId = chip.dataset.typeId;
      if (!typeId) return;

      selectedTypeId = typeId;
      updateActiveChip();
      renderItems();
    });

    // Item cards: expand/collapse & claim button
    itemsGridEl.addEventListener("click", (event) => {
      // If clicking the image on an expanded card, open the image modal
      const imgEl = event.target.closest(".item-image");
      if (imgEl) {
        const card = imgEl.closest(".item-card");
        if (card && card.classList.contains("expanded")) {
          event.stopPropagation();
          openImageModal(imgEl.src, imgEl.alt || "Item image");
          return;
        }
        // If the card is not yet expanded, let the normal click logic
        // run and just expand the card.
      }

      const claimBtn = event.target.closest(".claim-btn");
      if (claimBtn) {
        event.stopPropagation();
        const id = claimBtn.dataset.claimId;
        if (id) {
          handleClaimButtonClick(id);
        }
        return;
      }

      const card = event.target.closest(".item-card");
      if (!card) return;
      if (card.classList.contains("claimed")) return; // don't expand already-claimed items

      card.classList.toggle("expanded");
    });

    // Filter chips (multi-select)
    if (filtersSectionEl) {
      filtersSectionEl.addEventListener("click", (event) => {
        // 1) Header click: expand/collapse group
        const headerBtn = event.target.closest("[data-filter-toggle]");
        if (headerBtn) {
          const key = headerBtn.dataset.filterToggle;
          if (key) {
            toggleFilterGroup(key);
          }
          return;
        }

        // 2) Chip click: toggle filter value
        const chip = event.target.closest(".filter-chip");
        if (chip) {
          const key = chip.dataset.filterKey;
          const value = chip.dataset.filterValue;
          if (!key || value === undefined) return;

          toggleFilter(key, value);
        }
      });
    }

    // Reset all filters
    if (filtersResetBtn) {
      filtersResetBtn.addEventListener("click", () => {
        resetFilters();
      });
    }

    
    // Claim modal buttons
    claimCancelBtn.addEventListener("click", () => {
      closeClaimModal();
    });

    claimModalCloseBtn.addEventListener("click", () => {
      closeClaimModal();
    });

    claimSubmitBtn.addEventListener("click", () => {
      handleSubmitClaim();
    });

    // Allow pressing Enter in email field to submit
    claimEmailInput.addEventListener("keydown", (event) => {
      if (event.key === "Enter") {
        event.preventDefault();
        handleSubmitClaim();
      }
    });

    // Info modal OK button
    infoModalOkBtn.addEventListener("click", () => {
      closeInfoModal();
    });

    // Close modals when clicking outside
    claimModalBackdrop.addEventListener("click", (event) => {
      if (event.target === claimModalBackdrop) {
        closeClaimModal();
      }
    });
    infoModalBackdrop.addEventListener("click", (event) => {
      if (event.target === infoModalBackdrop) {
        closeInfoModal();
      }
    });

    imageModalBackdrop.addEventListener("click", (event) => {
      if (event.target === imageModalBackdrop) {
        closeImageModal();
      }
    });

    imageModalCloseBtn.addEventListener("click", () => {
      closeImageModal();
    });

    
    // Basic Escape key handling to close modals
    document.addEventListener("keydown", (event) => {
      if (event.key === "Escape") {
        if (claimModalBackdrop.classList.contains("active")) {
          closeClaimModal();
        } else if (infoModalBackdrop.classList.contains("active")) {
          closeInfoModal();
        } else if (imageModalBackdrop.classList.contains("active")) {
          closeImageModal();
        }
      }
    });

    // ================================================================
    // INITIALIZATION
    // ================================================================

    (async function init() {
      await loadInitialInventory();
    })();
  </script>
</body>
</html>
